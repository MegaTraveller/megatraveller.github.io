{%- if site.utterances.follow_site_theme -%}
<div id="utterances-placeholder"></div>
<script>
    if (document.cookie.indexOf("cookie-consent-marketing=true") != -1) {
        const utterancesThemeFromDataTheme = () => {
            const dataTheme =
                document.documentElement.getAttribute("data-theme");
            return `github-${dataTheme}`;
        };

        const setUtterancesTheme = () => {
            const iframe = document.querySelector(".utterances-frame");
            if (iframe) {
                const message = {
                    type: "set-theme",
                    theme: utterancesThemeFromDataTheme(),
                };
                iframe.contentWindow.postMessage(
                    message,
                    "https://utteranc.es",
                );
            }
        };

        // dynamic change
        const observer = new MutationObserver((mutationsList, observer) => {
            for (let mutation of mutationsList) {
                if (
                    mutation.type === "attributes" &&
                    mutation.attributeName === "data-theme"
                ) {
                    setUtterancesTheme();
                }
            }
        });
        observer.observe(document.documentElement, {
            attributes: true,
            childList: false,
            subtree: false,
        });

        let utterancesScript = document.createElement("script");
        utterancesScript.async = true;
        utterancesScript.src = "https://utteranc.es/client.js";
        utterancesScript.crossOrigin = "anonymous";
        utterancesScript.setAttribute(
            "issue-term",
            "{{ site.utterances.issue_term }}",
        );
        utterancesScript.setAttribute("label", "{{ site.utterances.label }}");
        utterancesScript.setAttribute("repo", "{{ site.utterances.repo }}");
        utterancesScript.setAttribute("theme", utterancesThemeFromDataTheme());

        const placeholder = document.getElementById("utterances-placeholder");
        placeholder.parentNode.replaceChild(utterancesScript, placeholder);
    }
</script>
{%- else -%}
<script>
    if (document.cookie.indexOf("cookie-consent-marketing=true") != -1) {
        let utterancesScript = document.createElement("script");
        utterancesScript.async = true;
        utterancesScript.src = "https://utteranc.es/client.js";
        utterancesScript.crossOrigin = "anonymous";
        utterancesScript.setAttribute(
            "issue-term",
            "{{ site.utterances.issue_term }}",
        );
        utterancesScript.setAttribute("label", "{{ site.utterances.label }}");
        utterancesScript.setAttribute("repo", "{{ site.utterances.repo }}");
        utterancesScript.setAttribute("theme", "{{ site.utterances.theme }}");

        const placeholder = document.getElementById("utterances-placeholder");
        placeholder.parentNode.replaceChild(utterancesScript, placeholder);
    }
</script>
{%- endif -%}
